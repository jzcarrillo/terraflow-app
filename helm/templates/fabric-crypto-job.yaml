{{- if .Values.fabric.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: fabric-crypto-generator
  namespace: {{ .Release.Namespace }}
spec:
  backoffLimit: 2
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: crypto-generator
        image: hyperledger/fabric-tools:2.4
        command: ["/bin/bash", "-c"]
        args:
        - |
          set -ex
          echo "üîê Generating minimal crypto materials..."
          
          # Create minimal MSP structure for orderer
          mkdir -p /crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/msp/signcerts
          mkdir -p /crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/msp/keystore
          mkdir -p /crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/msp/cacerts
          mkdir -p /crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/msp/admincerts
          
          # Create minimal MSP structure for peer
          mkdir -p /crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/msp/signcerts
          mkdir -p /crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/msp/keystore
          mkdir -p /crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/msp/cacerts
          mkdir -p /crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/msp/admincerts
          
          # Generate dummy certificates (for POC only)
          openssl req -x509 -newkey rsa:2048 -keyout /tmp/key.pem -out /tmp/cert.pem -days 365 -nodes -subj "/CN=orderer.example.com"
          cp /tmp/cert.pem /crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/msp/signcerts/cert.pem
          cp /tmp/key.pem /crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/msp/keystore/key.pem
          cp /tmp/cert.pem /crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/msp/cacerts/ca.pem
          
          openssl req -x509 -newkey rsa:2048 -keyout /tmp/peer-key.pem -out /tmp/peer-cert.pem -days 365 -nodes -subj "/CN=peer0.org1.example.com"
          cp /tmp/peer-cert.pem /crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/msp/signcerts/cert.pem
          cp /tmp/peer-key.pem /crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/msp/keystore/key.pem
          cp /tmp/peer-cert.pem /crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/msp/cacerts/ca.pem
          
          echo "‚úÖ Crypto materials generated"
          ls -laR /crypto-config/
        volumeMounts:
        - name: crypto-storage
          mountPath: /crypto-config
      volumes:
      - name: crypto-storage
        persistentVolumeClaim:
          claimName: fabric-crypto-pvc
{{- end }}